<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â§©Â†ÇWÁéãÂúòÁßòÊõ∏</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script>
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: "Microsoft JhengHei", sans-serif; padding-bottom: 50px; }
        .card { background-color: #1e1e1e; border: 1px solid #333; border-radius: 12px; height: 100%; transition: 0.5s; }
        .boss-name { font-size: 1.05rem; font-weight: bold; color: #ffca2c; }
        .countdown { font-size: 1.3rem; font-family: 'Segoe UI', monospace; color: #00ff00; font-weight: bold; }
        .warning { background-color: #4a0000 !important; border-color: #ff0000; animation: blinker 1.5s linear infinite; }
        .off-day { opacity: 0.3; filter: grayscale(1); }
        @keyframes blinker { 50% { opacity: 0.7; } }
        .btn-gold { background-color: #ffca2c; color: #000; font-weight: bold; border: none; }
        .badge-fixed { background-color: #0d6efd; padding: 4px 8px; font-size: 0.75rem; }
        .badge-cd { background-color: #6c757d; padding: 4px 8px; font-size: 0.75rem; }
        .alias-text { font-size: 0.75rem; color: #888; margin-bottom: 5px; }
        .info-row { border-top: 1px solid #333; margin-top: auto; padding-top: 8px; }
        .label-text { font-size: 0.75rem; color: #aaa; }
        #syncStatus.sync-flash { animation: flash 0.5s ease; }
        @keyframes flash { 0% { opacity: 1; } 50% { opacity: 0.3; background-color: #ffca2c; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="container py-4">
    <h3 class="text-center mb-4">üõ°Ô∏è Â§©Â†ÇWÁéãÂúòÁßòÊõ∏</h3>
    
    <div class="card p-3 mb-4 shadow">
        <div class="input-group">
            <input type="text" id="cmd" class="form-control" placeholder="Ëº∏ÂÖ•: 1930Â∑®È±∑ Êàñ ÁÆ°ÁêÜÊåá‰ª§">
            <button class="btn btn-gold" onclick="handleCommand()">Âü∑Ë°å</button>
        </div>
        <div class="mt-2 text-center">
            <button class="btn btn-outline-warning btn-sm m-1" onclick="handleCommand('CDÊ∏õÂçä')">‚ö° CDÊ∏õÂçä</button>
            <button class="btn btn-outline-secondary btn-sm m-1" onclick="handleCommand('CDÊÅ¢Âæ©')">üîÑ CDÊÅ¢Âæ©</button>
            <span id="syncStatus" class="badge bg-secondary ms-2">ÈÄ£Á∑ö‰∏≠...</span>
        </div>
    </div>

    <div id="bossContainer" class="row g-2"></div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAiPLZv4zBUDG3z2zQSnlt31K-IOoLW-Gs",
  authDomain: "mybosstimer.firebaseapp.com",
  databaseURL: "https://mybosstimer-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "mybosstimer",
  storageBucket: "mybosstimer.firebasestorage.app",
  messagingSenderId: "43002364713",
  appId: "1:43002364713:web:8a19b0c5eb5eae4d3b6d38",
  measurementId: "G-NQW3C870WF"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const dataRef = db.ref('bossData/SECRETARY_PRO_DATA'); 

let bosses = [];
let isFirstLoad = true;

dataRef.on('value', (snapshot) => {
    const data = snapshot.val();
    const initialList = getInitialData();
    if (!data || data.length < 5) { 
        if (isFirstLoad) { bosses = initialList; saveToCloud(); }
    } else { bosses = data; }
    updateStatus("ÁßòÊõ∏ÂêåÊ≠•‰∏≠", "bg-success");
    render();
    isFirstLoad = false;
});

function handleCommand(manual) {
    const input = (manual || document.getElementById('cmd').value).trim();
    document.getElementById('cmd').value = '';
    if(!input) return;
    let needUpdate = false;
    if (input === "CDÊ∏õÂçä") {
        bosses.forEach(b => { if(b.type === 'cd') { b.cd = b.origCd / 2; if(b.lastDeath) b.spawn = b.lastDeath + (b.cd * 3600000); } });
        needUpdate = true;
    } else if (input === "CDÊÅ¢Âæ©") {
        bosses.forEach(b => { if(b.type === 'cd') { b.cd = b.origCd; if(b.lastDeath) b.spawn = b.lastDeath + (b.cd * 3600000); } });
        needUpdate = true;
    } else if (input.startsWith("Êñ∞Â¢û") || input.startsWith("‰øÆÊîπ")) {
        const p = input.split(",");
        if(p.length >= 3) {
            const name = p[1], cd = parseFloat(p[2]), alias = p[3] || "";
            const idx = bosses.findIndex(b => b.name === name);
            if(idx > -1) bosses[idx] = { ...bosses[idx], cd, origCd: cd, alias };
            else bosses.push({ name, type: "cd", cd, origCd: cd, alias, spawn: null, lastDeath: null });
            needUpdate = true;
        }
    } else if (input.startsWith("Âà™Èô§")) {
        const name = input.split(",")[1];
        bosses = bosses.filter(b => b.name !== name);
        needUpdate = true;
    } else if (input.match(/^\d{4}/)) {
        const tStr = input.substring(0,4), alias = input.substring(4);
        const b = bosses.find(x => x.name.includes(alias) || x.alias.includes(alias));
        if(b && b.type==='cd') {
            let d = new Date(); d.setHours(tStr.substring(0,2), tStr.substring(2,4), 0, 0);
            if(d > new Date()) d.setDate(d.getDate()-1);
            b.lastDeath = d.getTime(); b.spawn = b.lastDeath + (b.cd * 3600000);
            needUpdate = true;
        }
    }
    if(needUpdate) { flashStatus(); saveToCloud(); }
}

function saveToCloud() { dataRef.set(bosses); }
function updateStatus(text, className) { const s = document.getElementById('syncStatus'); s.innerText = text; s.className = "badge ms-2 " + className; }
function flashStatus() { const s = document.getElementById('syncStatus'); s.classList.add('sync-flash'); setTimeout(() => s.classList.remove('sync-flash'), 500); }

function getInitialData() {
    return [
        { name: "ÈòøÂãíÂ∞º‰∫û", type: "fixed", times: ["17:30"], alias: "ËúòËõõ" },
        { name: "ÂÖãÁâπ", type: "fixed", times: ["18:00"], alias: "ÂÖãÁâπ" },
        { name: "Â∑´Â∏´", type: "fixed", times: ["18:20"], alias: "Â∑´Â∏´" },
        { name: "ÈòøÁàæÊñØÂç°Âà©‰∫û", type: "fixed", times: ["18:40"], alias: "ËÆäÊÄ™" },
        { name: "ÈªëËâ≤‰∫°ÈùàËêäÂ•ßÊñØ", type: "fixed", times: ["19:00"], alias: "‰∫û‰∏â" },
        { name: "ËêäËåµÂìàÂæ∑", type: "fixed", times: ["01:00","03:00","05:00","07:00","09:00","11:00","13:00","15:00","17:00","19:00","21:00","23:00"], alias: "Ë©±2" },
        { name: "ÈëΩÁü≥È´òÂ¥ô", type: "fixed", weekday: 1, times: ["19:00"], alias: "ÈëΩÈ´ò" },
        { name: "ËàπÈï∑Âç°Âà©Á¥¢", type: "fixed", weekday: 2, times: ["19:00"], alias: "ËàπÈï∑" },
        { name: "ÁãÇÈ¢®ÁöÑÂ§èÊñØÂ•á", type: "fixed", weekday: 3, times: ["19:00"], alias: "Â§èÊñØÂ•á" },
        { name: "ÁñæÈ¢®ÁöÑÂ∑®Â§ßÈ£õÈæç", type: "fixed", weekday: 4, times: ["19:00"], alias: "Â∑®È£õ" },
        { name: "ÈªëËôéÊÅ∞ÂßÜÂ∏ïÁì¶Áâπ", type: "cd", cd: 4, origCd: 4, alias: "ÈªëËôé,ËÄÅËôé", spawn: null, lastDeath: null },
        { name: "Â∞ºÁæÖÂæ∑", type: "cd", cd: 4, origCd: 4, alias: "ÈáéË±¨", spawn: null, lastDeath: null },
        { name: "ËåâËéâÊèê‰∫û", type: "cd", cd: 4, origCd: 4, alias: "Â∞èËåâ", spawn: null, lastDeath: null },
        { name: "ÈªëËõáÈ®éÂ£´ÂúòÈ∫•ËÇØ", type: "cd", cd: 4, origCd: 4, alias: "È∫•ËÇØ", spawn: null, lastDeath: null },
        { name: "Âè≤ÂâçÂ∑®È±∑", type: "cd", cd: 8, origCd: 8, alias: "Â∑®È±∑,È±∑È≠ö", spawn: null, lastDeath: null },
        { name: "Â•àÂÖãÂÅåÊñØ", type: "cd", cd: 8, origCd: 8, alias: "Â•àÂÖã,ÈòøÂêêÂ∑¥", spawn: null, lastDeath: null },
        { name: "ÁÉèÂãíÂ∫´ÊñØ", type: "cd", cd: 8, origCd: 8, alias: "ÁÉèÂãí", spawn: null, lastDeath: null },
        { name: "ÂØ©Âà§ËÄÖÊãâÈ¶¨‰øÆ", type: "cd", cd: 8, origCd: 8, alias: "ÊãâÈ¶¨‰øÆ,ËõáÂ•≥", spawn: null, lastDeath: null },
        { name: "Â∫´ÁàæÊâò", type: "cd", cd: 8, origCd: 8, alias: "ÁãºÁéã,Áãº‰∫∫", spawn: null, lastDeath: null },
        { name: "Â∑®‰∫∫", type: "cd", cd: 12, origCd: 12, alias: "Â∑®‰∫∫Áéã", spawn: null, lastDeath: null }
    ];
}

function render() {
    const container = document.getElementById('bossContainer');
    container.innerHTML = '';
    const now = new Date();
    const today = now.getDay() === 0 ? 7 : now.getDay();
    const weekMap = ["", "ÈÄ±‰∏Ä", "ÈÄ±‰∫å", "ÈÄ±‰∏â", "ÈÄ±Âõõ", "ÈÄ±‰∫î", "ÈÄ±ÂÖ≠", "ÈÄ±Êó•"];

    let sorted = bosses.map(b => {
        let sortTime = 9999999999999, isOffDay = false, displayTime = "Êú™Ë®òÈåÑ", countdownText = "‰∏ãÊ¨°ÈáçÁîüÔºö", isWarn = false;
        
        if(b.type === 'fixed') {
            if(b.weekday && b.weekday !== today) {
                isOffDay = true;
                displayTime = `ÈÄ±(${b.weekday}) ${b.times[0]}`;
                // ÊéíÂ∫èÊ¨äÈáçÔºöÈùû‰ªäÂ§©Áéã = Âü∫Á§éÂ§ßÊ¨äÈáç + ÈÄ±Â∫è(100Ëê¨Á¥ö) + ÊôÇÈñì
                sortTime = 2000000000000 + (b.weekday * 100000000); 
            } else {
                let found = false;
                for(let t of b.times) {
                    let target = new Date(); target.setHours(t.split(':')[0], t.split(':')[1], 0, 0);
                    if((target - now) / 60000 > -5) { sortTime = target.getTime(); displayTime = t; if((target - now) / 60000 <= 5) isWarn = true; found = true; break; }
                }
                if(!found) { displayTime = "‰ªäÊó•Â∑≤ÁµêÊùü"; isOffDay = true; sortTime = 3000000000000; }
            }
        } else if (b.spawn) {
            sortTime = b.spawn;
            let diff = (b.spawn - now.getTime()) / 60000;
            let sDate = new Date(b.spawn);
            displayTime = sDate.getHours().toString().padStart(2,'0') + ":" + sDate.getMinutes().toString().padStart(2,'0');
            if(diff <= 5 && diff > 0) isWarn = true;
            countdownText = diff <= 0 ? "Â∑≤ÈáçÁîüÔºÅ" : `Ââ©È§ò ${Math.floor(diff/60)}ÊôÇ${Math.floor(diff%60)}ÂàÜ`;
        }
        return { ...b, sortTime, isOffDay, displayTime, countdownText, isWarn };
    });

    sorted.sort((a, b) => a.sortTime - b.sortTime);

    sorted.forEach(b => {
        let label = "Âõ∫ÂÆö";
        if(b.type === 'fixed' && b.weekday) label = `Âõ∫ÂÆö(${weekMap[b.weekday]})`;
        else if(b.type === 'cd') label = `CD ${b.cd}h`;

        container.innerHTML += `
            <div class="col-6 col-md-4 col-lg-3">
                <div class="card p-2 ${b.isOffDay ? 'off-day' : ''} ${b.isWarn ? 'warning' : ''}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="boss-name text-truncate">${b.name}</div>
                        <span class="badge ${b.type==='fixed'?'badge-fixed':'badge-cd'}">${label}</span>
                    </div>
                    <div class="alias-text text-truncate">${b.alias}</div>
                    <div class="info-row">
                        <div class="label-text">${b.countdownText}</div>
                        <div class="countdown">${b.displayTime}</div>
                    </div>
                </div>
            </div>`;
    });
}
setInterval(render, 10000); 
render();
</script>
</body>
</html>